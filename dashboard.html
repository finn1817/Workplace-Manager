<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Workplace Scheduler Dashboard</title>
	<style>
		/* Minimal shell; the full styling and UI structure is ported from the original dashboard */
		body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background:#0b0b0b; color:#e5e7eb; }
		.header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; }
		.container { max-width: 1400px; margin: 0 auto; padding: 2rem; }
		.section { margin-bottom: 2rem; }
		.workplace-grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(360px,1fr)); gap:1.25rem; }
		/* Workplace tiles: default banner blue; selected stays green */
		.workplace-card { background: var(--banner-blue, #0033A0) !important; color:#fff; padding:1.25rem; border-radius:12px; cursor:pointer; text-align:center; border: 1px solid rgba(0,0,0,0.25); }
		.workplace-card.selected { background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important; }
		/* Unified button look across the page */
		.btn { padding: 0.7rem 1.1rem; border-radius:10px; cursor:pointer; font-weight:600; border:2px solid #000 !important; background:#60a5fa !important; color:#000 !important; box-shadow:none !important; }
		.btn:hover { filter: brightness(0.95); }
		.btn-danger { background:#ef4444 !important; color:#fff !important; border-color:#111 !important; }
		.btn-muted { background:#94a3b8 !important; color:#111 !important; }
		.btn-link { background:transparent !important; border-color:transparent !important; color:#60a5fa !important; }
		.actions-bar { display:flex; flex-wrap:wrap; gap:.6rem; align-items:center; }
		.actions-bar .btn { min-width: 240px; justify-content:center; }
		/* Section banners: match header banner blue regardless of theme */
		.card { background: var(--banner-blue, #0033A0) !important; border:1px solid rgba(0,0,0,0.25); border-radius:12px; padding:1rem; }
		.card h3 { margin:0 0 .75rem 0; color:#ffffff; font-size:1.05rem; }
		.card .group { display:flex; flex-wrap:wrap; gap:.6rem; }
		.loading { text-align:center; color:#93c5fd; padding:1rem; }
		.error { background:#7f1d1d; border:1px solid #dc2626; color:#fecaca; padding:1rem; border-radius:8px; margin:1rem 0; }
		.info { background:#d1ecf1; border:1px solid #bee5eb; color:#0c5460; padding:1rem; border-radius:8px; margin:1rem 0; }
		.day-header { margin: 1rem 0 .25rem; }
		.shift { padding:.4rem .6rem; background:#111827; border:1px solid #1f2937; border-radius:8px; margin:.25rem 0; }

		/* Consistent header button look (black outline, blue background, black text) */
		.header .header-btn { 
			background: var(--header-button-blue, #60a5fa) !important; /* lighter blue for black text readability */
			color: #000 !important;
			border: 2px solid #000 !important;
			border-radius: 10px !important;
			box-shadow: none !important;
			padding: 0.6rem 1rem !important;
		}
		.header .header-btn + .header-btn { margin-left: .5rem; }
		.header .header-btn:hover { filter: brightness(0.95); }
	</style>
    <link rel="stylesheet" href="./theme/theme-toggle-per-user.css" />
</head>
<body>
    <script type="module" src="./theme/theme-toggle-per-user.js"></script>
	<div class="header">
		<h1>ğŸ¢ Workplace Scheduler</h1>
		<div>
			<a id="manageWorkersBtn" class="btn header-btn" href="manage-workers.html" style="display:none;">ğŸ‘¥ Manage Workers</a>
			<button class="btn header-btn" id="myAccountBtn">ğŸ‘¤ My Account</button>
			<button class="btn header-btn" id="logoutBtn">Logout</button>
		</div>
	</div>
	<div id="adminControls" class="container" style="display:none;">
		<h2>Admin Controls</h2>
		<div class="card section">
			<h3>Worker Management</h3>
			<div class="group">
				<button class="btn" id="btnManageHours">ğŸ•’ Manage Hours</button>
				<a class="btn" id="btnAdminManageWorkers" href="manage-workers.html">ğŸ‘¥ Manage Workers</a>
				<button class="btn" id="btnAdminAddWorker">â• Add Worker</button>
				<a class="btn" id="btnImportWorkers" href="manage-workers.html?import=1">ğŸ“¥ Import Workers</a>
			</div>
		</div>
		<div class="card section">
			<h3>Requests</h3>
			<div class="group">
				<button class="btn" id="btnHourRequests">â³ Hour Requests</button>
				<button class="btn" id="btnTimeOff">ğŸ–ï¸ Time Off Requests</button>
				<button class="btn" id="btnShiftSwap">ğŸ” Shift Swap Requests</button>
				<a class="btn" id="btnEmailChange" href="admin-requests.html#emailchange">âœ‰ï¸ Email Change Requests</a>
				<a class="btn" id="btnViewMessages" href="admin-messages.html">ğŸ’¬ View Messages</a>
			</div>
		</div>
		<div class="card section">
			<h3>Maintenance</h3>
			<div class="group">
				<button class="btn btn-danger" id="btnRemoveAllWorkers">ğŸ—‘ï¸ Remove All Workers</button>
				<button class="btn btn-danger" id="btnCleanupSchedules">ğŸ§¹ Clean Up Old Schedules</button>
			</div>
		</div>
		<div style="margin-top:.5rem;color:#6c757d;font-size:.9rem;">Note: Database Maintenance and Force Auto-Restore are intentionally omitted.</div>
	</div>

	<div class="container">
		<div class="workplace-section">
			<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
				<h2 style="margin:0;">Select Workplace</h2>
				<button id="clearWorkplaceBtn" class="btn" style="background:#6c757d;color:white;">âœ• Clear Selection</button>
			</div>
			<div class="workplace-grid">
				<div class="workplace-card" data-wp="esports_lounge"><h4>ğŸ® eSports Lounge</h4><p>esports_lounge</p></div>
				<div class="workplace-card" data-wp="esports_arena"><h4>ğŸŸï¸ eSports Arena</h4><p>esports_arena</p></div>
				<div class="workplace-card" data-wp="it_service_center"><h4>ğŸ’» IT Service Center</h4><p>it_service_center</p></div>
			</div>
		</div>

		<div id="actions" class="actions-bar" style="display:none;margin:1rem 0;">
			<button id="generateBtn" class="btn">ğŸ“… Generate New Schedule</button>
			<button id="viewCurrentBtn" class="btn">ğŸ‘ï¸ View Current Schedule</button>
			<button id="showWorkersBtn" class="btn">ğŸ‘¥ Show All Workers</button>
		</div>

		<div id="scheduleDisplay" class="info">ğŸ’¡ Select a workplace above to get started with scheduling and management.</div>
	</div>

	<script type="module">
		import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js';
		import { getFirestore, collection, getDocs, addDoc, setDoc, doc, updateDoc, query, where, deleteDoc, getDoc } from 'https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js';
		import { getStorage } from 'https://www.gstatic.com/firebasejs/11.10.0/firebase-storage.js';
		import { getDBForWorkplace, getStorageForWorkplace } from './firebase/config.js';
		import { isAdminUser } from './JS/admin-status.js';
		import { addWorker } from './JS/worker-CRUD.js';

		// Auth user from localStorage
		const user = JSON.parse(localStorage.getItem('user') || '{}');
		if (!user || !user.email) {
			// Redirect to login if not signed in
			window.location.href = 'index.html';
		}

		// Current state
		let selectedWorkplace = null;
		let db = null; let storage = null;
		let isAdmin = false;

		function useWorkplace(id) {
			selectedWorkplace = id;
			db = getDBForWorkplace(id);
			storage = getStorageForWorkplace(id);
		}

		// COLLECTION PATHS under per-workplace databases (flatter, no /workplaces/{id}/ prefix)
		const Paths = {
			workers: 'workers',
			schedules: 'schedules',
			announcements: 'announcements',
			shift_postings: 'shift_postings',
			coverage_requests: 'coverage_requests',
			active_coverage: 'active_coverage'
		};

		// Minimal helpers from original app
		async function loadWorkplaceData() {
			// Attempt to fetch hours_of_operation if stored in a settings doc, otherwise default 9-5 M-F
			// In the original schema, hours lived on workplaces collection; with per-DB, store in settings/general
			try {
				// Preferred: single deterministic doc id
				const preferred = await getDoc(doc(db, 'settings', 'general'));
				let hours = preferred.exists() ? (preferred.data()||{}).hours_of_operation : null;
				// Fallback: scan legacy docs in settings
				if (!hours) {
					const settingsSnap = await getDocs(collection(db, 'settings'));
					settingsSnap.forEach(d => { const data = d.data(); if (data && data.hours_of_operation) hours = data.hours_of_operation; });
				}
				if (!hours) {
					hours = {
						Monday: { open: '09:00', close: '17:00' },
						Tuesday: { open: '09:00', close: '17:00' },
						Wednesday: { open: '09:00', close: '17:00' },
						Thursday: { open: '09:00', close: '17:00' },
						Friday: { open: '09:00', close: '17:00' },
						Saturday: { open: null, close: null },
						Sunday: { open: null, close: null }
					};
				}
				return hours;
			} catch (e) {
				console.warn('Falling back to default hours:', e);
				return {
					Monday: { open: '09:00', close: '17:00' },
					Tuesday: { open: '09:00', close: '17:00' },
					Wednesday: { open: '09:00', close: '17:00' },
					Thursday: { open: '09:00', close: '17:00' },
					Friday: { open: '09:00', close: '17:00' },
					Saturday: { open: null, close: null },
					Sunday: { open: null, close: null }
				};
			}
		}

		async function fetchWorkers() {
			const snap = await getDocs(collection(db, Paths.workers));
			return snap.docs.map(d => ({ id: d.id, ...d.data() }));
		}

		function parseAvailabilityString(text) {
			// Very simplified parser matching the original idea
			const days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
			const map = { Sun: 'Sunday', Mon: 'Monday', Tue: 'Tuesday', Wed: 'Wednesday', Thu: 'Thursday', Fri: 'Friday', Sat: 'Saturday' };
			const availability = {};
			if (!text) return availability;
			text.split(',').map(s => s.trim()).forEach(block => {
				const m = block.match(/^(Sun|Mon|Tue|Wed|Thu|Fri|Sat)\s+(\d{1,2})(?::(\d{2}))?\s*(am|pm)?\s*-\s*(\d{1,2})(?::(\d{2}))?\s*(am|pm)?$/i);
				if (!m) return;
				const day = map[m[1]];
				function toMinutes(h, mins, ap) {
					let hh = parseInt(h,10);
					let mm = mins?parseInt(mins,10):0;
					if (ap) {
						const apL = ap.toLowerCase();
						if (apL === 'pm' && hh < 12) hh += 12;
						if (apL === 'am' && hh === 12) hh = 0;
					}
					return hh*60+mm;
				}
				const start = toMinutes(m[2], m[3], m[4]);
				const end = toMinutes(m[5], m[6], m[7]);
				if (!availability[day]) availability[day] = [];
				availability[day].push({ start, end });
			});
			return availability;
		}

		function isAvailable(worker, day, startMin, endMin) {
			const slots = (worker.availabilityParsed && worker.availabilityParsed[day]) || [];
			return slots.some(s => s.start <= startMin && s.end >= endMin);
		}

		// Core schedule generation honoring Work Study 5-hour rule
		async function generateSchedule() {
			const scheduleDisplay = document.getElementById('scheduleDisplay');
			scheduleDisplay.innerHTML = '<div class="loading">ğŸš€ Generating schedule...</div>';

			const hours = await loadWorkplaceData();
			const workers = await fetchWorkers();
			// Normalize availability
			workers.forEach(w => { if (typeof w['Availability'] === 'string') w.availabilityParsed = parseAvailabilityString(w['Availability']); else w.availabilityParsed = w.availability || {}; });

			const DAYS = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];

			// Build open windows per day (1h blocks for simplicity)
			const windows = {};
			DAYS.forEach(d => {
				const o = hours[d];
				if (!o || !o.open || !o.close) { windows[d] = []; return; }
				const [oh, om] = o.open.split(':').map(Number);
				const [ch, cm] = o.close.split(':').map(Number);
				const start = oh*60+om; const end = ch*60+cm;
				const slots = [];
				for (let t=start; t<end; t+=60) slots.push({ start:t, end:Math.min(t+60, end), assigned:[] });
				windows[d] = slots;
			});

			// Assign Work Study exactly 5 hours
			const workStudy = workers.filter(w => (w['Worker Type']==='Work Study' || w['Work Study']==='Yes') && w['Worker Type'] !== 'Cover');
			const regular = workers.filter(w => !(w['Worker Type']==='Work Study' || w['Work Study']==='Yes') && w['Worker Type'] !== 'Cover');

			const assignedHours = Object.fromEntries(workers.map(w => [w['Email'] || w.email, 0]));

			function tryAssign(worker, neededHours) {
				let remaining = neededHours;
				for (const d of DAYS) {
					for (const slot of windows[d]) {
						if (slot.assigned.length >= 2) continue; // capacity 2
						if (!isAvailable(worker, d, slot.start, slot.end)) continue;
						const key = worker['Email'] || worker.email;
						slot.assigned.push({ email:key, name:`${worker['First Name']||worker.first_name||''} ${worker['Last Name']||worker.last_name||''}`.trim(), ws: (w=> (w['Worker Type']==='Work Study'||w['Work Study']==='Yes'))(worker) });
						assignedHours[key] += (slot.end-slot.start)/60;
						remaining -= (slot.end-slot.start)/60;
						if (remaining <= 0) return true;
					}
				}
				return remaining <= 0;
			}

			// WS first
			for (const w of workStudy) {
				const ok = tryAssign(w, 5);
				if (!ok) {
					scheduleDisplay.innerHTML = `<div class="error">ğŸš¨ Work Study availability issue for ${w['First Name']} ${w['Last Name']} â€” they must have at least 5 hours within operating hours.</div>`;
					return;
				}
			}

			// Regulars: fair distribution
			// target = remaining available capacity / number of regulars
			const totalCapacity = Object.values(windows).flat().length * 2; // slots * 1h * capacity 2
			const wsHours = workStudy.length * 5;
			const remainingTarget = Math.max(0, totalCapacity - wsHours);
			const targetPerRegular = regular.length>0 ? remainingTarget/regular.length : 0;

			for (const w of regular) {
				tryAssign(w, targetPerRegular);
			}

			// Persist as current schedule document
			const scheduleDoc = { isCurrent:true, createdAt:new Date().toISOString(), workplace:selectedWorkplace, schedule: {} };
			for (const d of DAYS) {
				scheduleDoc.schedule[d] = windows[d].map(s => ({ start:s.start, end:s.end, assigned:s.assigned }));
			}
			// Upsert current schedule (replace existing current if any)
			const existing = await getDocs(query(collection(db, Paths.schedules), where('isCurrent','==',true)));
			if (!existing.empty) {
				await updateDoc(existing.docs[0].ref, scheduleDoc);
			} else {
				await addDoc(collection(db, Paths.schedules), scheduleDoc);
			}

			// Render
			const fmt = m => {
				const h = Math.floor(m/60), mm = (m%60).toString().padStart(2,'0');
				const ap = h>=12?'PM':'AM';
				const hh = (h%12)||12; return `${hh}:${mm} ${ap}`;
			};
			let html = '';
			for (const d of DAYS) {
				html += `<h3 class="day-header">${d}</h3>`;
				for (const s of scheduleDoc.schedule[d]) {
					const names = s.assigned.map(a=>a.name||a.email).join(', ') || '(unfilled)';
					html += `<div class="shift">${fmt(s.start)} - ${fmt(s.end)} â€” ${names}</div>`;
				}
			}
			scheduleDisplay.innerHTML = html || '<div class="info">No shifts generated.</div>';
		}

		async function viewCurrentSchedule() {
			const scheduleDisplay = document.getElementById('scheduleDisplay');
			if (!db) { scheduleDisplay.innerHTML = '<div class="error">Select a workplace first.</div>'; return; }
			const snap = await getDocs(query(collection(db, 'schedules'), where('isCurrent','==',true)));
			if (snap.empty) { scheduleDisplay.innerHTML = '<div class="info">No current schedule found.</div>'; return; }
			const data = snap.docs[0].data();
			const DAYS = Object.keys(data.schedule||{});
			const fmt = m => { const h=Math.floor(m/60),mm=(m%60).toString().padStart(2,'0'); const ap=h>=12?'PM':'AM'; const hh=(h%12)||12; return `${hh}:${mm} ${ap}`; };
			let html='';
			for (const d of DAYS) {
				html += `<h3 class="day-header">${d}</h3>`;
				for (const s of data.schedule[d]) {
					const names = (s.assigned||[]).map(a=>a.name||a.email).join(', ') || '(unfilled)';
					html += `<div class="shift">${fmt(s.start)} - ${fmt(s.end)} â€” ${names}</div>`;
				}
			}
			scheduleDisplay.innerHTML = html || '<div class="info">No shifts to display.</div>';
		}

		// Show all workers for the selected workplace (read-only)
		function renderWorkersList(workers) {
			const cols = ['First Name','Last Name','Email','Worker Type'];
			let html = '<div class="card"><h3>All Workers</h3><div style="overflow:auto">';
			html += '<table style="width:100%;border-collapse:collapse;">';
			html += '<thead><tr>' + cols.map(c=>`<th style="text-align:left;border-bottom:1px solid #1f2937;padding:.5rem;">${c}</th>`).join('') + '</tr></thead>';
			html += '<tbody>' + workers.map(w=>`<tr>
				<td style="border-bottom:1px solid #1f2937;padding:.5rem;">${w['First Name']||''}</td>
				<td style="border-bottom:1px solid #1f2937;padding:.5rem;">${w['Last Name']||''}</td>
				<td style="border-bottom:1px solid #1f2937;padding:.5rem;">${w['Email']||w.email||''}</td>
				<td style="border-bottom:1px solid #1f2937;padding:.5rem;">${w['Worker Type']||w.type||''}</td>
			</tr>`).join('') + '</tbody>';
			html += '</table></div></div>';
			return html;
		}

		async function showAllWorkers() {
			const scheduleDisplay = document.getElementById('scheduleDisplay');
			if (!db) { scheduleDisplay.innerHTML = '<div class="error">Select a workplace first.</div>'; return; }
			scheduleDisplay.innerHTML = '<div class="loading">ğŸ‘¥ Loading workers...</div>';
			try {
				const workers = await fetchWorkers();
				scheduleDisplay.innerHTML = renderWorkersList(workers);
			} catch (e) {
				scheduleDisplay.innerHTML = `<div class="error">${e.message}</div>`;
			}
		}

		// Admin gating
		(async () => {
			const manageBtn = document.getElementById('manageWorkersBtn');
			try {
				isAdmin = await isAdminUser(user.email);
			} catch {}
			if (isAdmin) {
				manageBtn.style.display='inline-block';
				document.getElementById('adminControls').style.display='block';
			} else {
				// Hide Generate for non-admins immediately
				const gen = document.getElementById('generateBtn'); if (gen) gen.style.display='none';
			}
		})();

		// Wire UI
		const cards = document.querySelectorAll('.workplace-card');
		const scheduleDisplay = document.getElementById('scheduleDisplay');
		cards.forEach(card => card.addEventListener('click', async (e)=>{
			cards.forEach(c=>c.classList.remove('selected'));
			card.classList.add('selected');
			const id = card.getAttribute('data-wp');
			useWorkplace(id);
			document.getElementById('actions').style.display = 'block';
			// Show/Hide Generate based on admin status
			const gen = document.getElementById('generateBtn'); if (gen) gen.style.display = isAdmin ? 'inline-block' : 'none';
			scheduleDisplay.innerHTML = '<div class="loading">ğŸ”„ Loading workplace data...</div>';
			try {
				await viewCurrentSchedule();
			} catch (err) { scheduleDisplay.innerHTML = `<div class="error">${err.message}</div>`; }
		}));

		document.getElementById('clearWorkplaceBtn').addEventListener('click', ()=>{
			selectedWorkplace = null; db=null; storage=null;
			cards.forEach(c=>c.classList.remove('selected'));
			document.getElementById('actions').style.display='none';
			scheduleDisplay.innerHTML = '<div class="info">ğŸ’¡ Select a workplace above to get started with scheduling and management.</div>';
		});

		document.getElementById('generateBtn').addEventListener('click', async ()=>{
			if (!isAdmin) { scheduleDisplay.innerHTML = '<div class="error">Only admins can generate schedules.</div>'; return; }
			if (!db) { scheduleDisplay.innerHTML = '<div class="error">Select a workplace first.</div>'; return; }
			try { await generateSchedule(); } catch (e) { scheduleDisplay.innerHTML = `<div class=error>${e.message}</div>`; }
		});
		document.getElementById('viewCurrentBtn').addEventListener('click', viewCurrentSchedule);
		document.getElementById('showWorkersBtn').addEventListener('click', showAllWorkers);

		// Logout
		document.getElementById('logoutBtn').addEventListener('click', ()=>{ localStorage.removeItem('user'); window.location.href='index.html'; });
		document.getElementById('myAccountBtn').addEventListener('click', ()=>{ alert(`Logged in as ${user.email}\nAdmin: ${user.isAdmin? 'Yes': 'No'}`); });

		// Admin control handlers
		const WP_IDS = ['esports_lounge','esports_arena','it_service_center'];
		const pickWP = ()=> prompt('Workplace (esports_lounge, esports_arena, it_service_center)');

		document.getElementById('btnManageHours').onclick = ()=> window.location.href = 'manage-hours.html';
		document.getElementById('btnHourRequests').onclick = ()=> window.location.href = 'admin-requests.html#hours';
		document.getElementById('btnTimeOff').onclick = ()=> window.location.href = 'admin-requests.html#timeoff';
		document.getElementById('btnShiftSwap').onclick = ()=> window.location.href = 'admin-requests.html#shiftswap';
		document.getElementById('btnEmailChange').onclick = ()=> window.location.href = 'admin-requests.html#emailchange';

		document.getElementById('btnAdminAddWorker').onclick = async () => {
			const wp = pickWP(); if (!wp || !WP_IDS.includes(wp)) return alert('Invalid workplace');
			const firstName = prompt('First Name'); if (!firstName) return;
			const lastName = prompt('Last Name'); if (!lastName) return;
			const email = prompt('Email'); if (!email) return;
			const type = prompt('Worker Type (Work Study/Regular/Cover)','Regular');
			const availability = prompt('Availability','');
			await addWorker(getDBForWorkplace(wp), { 'First Name': firstName, 'Last Name': lastName, 'Email': email, 'Worker Type': type, 'Availability': availability });
			alert('Worker added');
		};

		document.getElementById('btnRemoveAllWorkers').onclick = async () => {
			const wp = pickWP(); if (!wp || !WP_IDS.includes(wp)) return alert('Invalid workplace');
			if (!confirm(`Delete ALL workers in ${wp}? This cannot be undone.`)) return;
			const dbSel = getDBForWorkplace(wp);
			const snap = await getDocs(collection(dbSel, 'workers'));
			await Promise.all(snap.docs.map(d => deleteDoc(d.ref)));
			alert(`Removed ${snap.size} workers from ${wp}.`);
		};

		document.getElementById('btnCleanupSchedules').onclick = async () => {
			const wp = pickWP(); if (!wp || !WP_IDS.includes(wp)) return alert('Invalid workplace');
			if (!confirm(`Clean up old schedules in ${wp}? (keeps current; deletes non-current older than 60 days)`)) return;
			const dbSel = getDBForWorkplace(wp);
			const now = Date.now();
			const snap = await getDocs(collection(dbSel, 'schedules'));
			let removed = 0;
			for (const d of snap.docs) {
				const data = d.data();
				if (data.isCurrent) continue;
				const t = Date.parse(data.createdAt || '') || 0;
				if (now - t > 1000*60*60*24*60) { await deleteDoc(d.ref); removed++; }
			}
			alert(`Removed ${removed} old schedules from ${wp}.`);
		};
	</script>
</body>
</html>
