<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Requests</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background:#f8f9fa; margin:0; }
    header { background:#0f172a; color:#fff; padding:1rem 1.5rem; display:flex; justify-content:space-between; align-items:center; }
    .container { max-width: 1100px; margin: 0 auto; padding: 1rem; }
    .tabs { display:flex; gap:.5rem; flex-wrap:wrap; margin-bottom: 1rem; }
    .tab { padding:.5rem .75rem; border-radius:8px; background:#e5e7eb; color:#111827; text-decoration:none; }
    .tab.active { background:#2563eb; color:#fff; }
    .wp-card { background:#fff; border:1px solid #e5e7eb; border-radius:10px; padding:1rem; margin-bottom:1rem; }
    table { width:100%; border-collapse: collapse; }
    th, td { border-bottom:1px solid #e5e7eb; padding:.5rem; text-align:left; font-size:.95rem; }
    th { background:#f3f4f6; }
    .btn { padding:.35rem .6rem; border:none; border-radius:6px; cursor:pointer; }
    .btn-approve { background:#16a34a; color:#fff; }
    .btn-deny { background:#f59e0b; color:#111; }
    .btn-delete { background:#dc2626; color:#fff; }
    .pill { background:#e5e7eb; border-radius:9999px; padding:.15rem .45rem; font-size:.8rem; }
  </style>
</head>
<body>
  <header>
    <h1 style="margin:0; font-size:1.1rem;">üóÇÔ∏è Admin Requests</h1>
    <a class="tab" href="dashboard.html" style="background:#475569;color:#fff;">‚¨Ö Back</a>
  </header>
  <div class="container">
    <div class="tabs">
      <a class="tab" data-hash="#hours" href="#hours">‚è≥ Hours</a>
      <a class="tab" data-hash="#timeoff" href="#timeoff">üèñÔ∏è Time Off</a>
      <a class="tab" data-hash="#shiftswap" href="#shiftswap">üîÅ Shift Swaps</a>
      <a class="tab" data-hash="#emailchange" href="#emailchange">‚úâÔ∏è Email Change</a>
    </div>
    <div id="status" class="pill">Loading‚Ä¶</div>
    <div id="content"></div>
  </div>

  <script type="module">
    import './firebase/config.js';
    import { AUTH_APP, getDBForWorkplace } from './firebase/config.js';
    import { guardAdminOrRedirect } from './JS/admin-status.js';
  import { getFirestore, collection, getDocs, query, where, updateDoc, deleteDoc, doc } from 'https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js';

    const AUTH_DB = getFirestore(AUTH_APP);
    const WP_IDS = ['esports_lounge','esports_arena','it_service_center'];
    const status = document.getElementById('status');
    const content = document.getElementById('content');

    function h(tag, attrs={}, children=[]) { const e=document.createElement(tag); Object.entries(attrs).forEach(([k,v])=>{ if(k==='html') e.innerHTML=v; else e.setAttribute(k,v); }); (Array.isArray(children)?children:[children]).forEach(c=>e.appendChild(typeof c==='string'?document.createTextNode(c):c)); return e; }

    function getView() {
      const hash = window.location.hash || '#hours';
      return ['#hours','#timeoff','#shiftswap','#emailchange'].includes(hash) ? hash : '#hours';
    }

    function setActiveTab() {
      document.querySelectorAll('.tab[data-hash]').forEach(a=>{ a.classList.toggle('active', a.getAttribute('data-hash')===getView()); });
    }

    async function loadWPRequests(col) {
      const results = {};
      for (const wp of WP_IDS) {
        const db = getDBForWorkplace(wp);
        const snap = await getDocs(collection(db, col));
        results[wp] = snap.docs.map(d=>({ id:d.id, ref:d.ref, ...d.data() }));
      }
      return results;
    }

    async function loadEmailChangeRequests() {
      const snap = await getDocs(collection(AUTH_DB, 'email_change_requests'));
      return snap.docs.map(d=>({ id:d.id, ref:d.ref, ...d.data() }));
    }

    function renderWPTable(title, items, onApprove, onDeny, onDelete) {
      const card = h('div', { class:'wp-card' });
      card.append(h('h3', {}, title));
      const table = h('table');
      const thead = h('thead');
      thead.append(h('tr',{},[h('th',{},'Name'),h('th',{},'Email'),h('th',{},'Details'),h('th',{},'Status'),h('th',{},'Actions')]));
      table.append(thead);
      const tbody = h('tbody');
      for (const it of items) {
        const details = it.details || it.reason || it.notes || JSON.stringify(it);
        const row = h('tr');
        row.append(h('td',{}, (it.name || `${it.first_name||''} ${it.last_name||''}`).trim()), h('td',{}, it.email || it.userEmail || ''), h('td',{}, details), h('td',{}, it.status||'pending'));
        const actions = h('td');
        const b1 = h('button',{class:'btn btn-approve'},'Approve'); b1.onclick=()=>onApprove(it);
        const b2 = h('button',{class:'btn btn-deny', style:'margin-left:4px;'},'Deny'); b2.onclick=()=>onDeny(it);
        const b3 = h('button',{class:'btn btn-delete', style:'margin-left:4px;'},'Delete'); b3.onclick=()=>onDelete(it);
        actions.append(b1,b2,b3); row.append(actions); tbody.append(row);
      }
      table.append(tbody); card.append(table); return card;
    }

    async function approveWP(item) { await updateDoc(item.ref, { status:'approved', handledAt: new Date().toISOString() }); }
    async function denyWP(item) { await updateDoc(item.ref, { status:'denied', handledAt: new Date().toISOString() }); }
    async function delWP(item) { await deleteDoc(item.ref); }

    async function approveEmailChange(item) {
      // item: expects { currentEmail or userEmail, newEmail }
      const cur = item.currentEmail || item.userEmail || item.email;
      const next = item.newEmail;
      if (!cur || !next) { alert('Missing email fields'); return; }
      // Check conflict
      const existingSnap = await getDocs(query(collection(AUTH_DB,'users'), where('email','==', next)));
      if (!existingSnap.empty) { alert('New email already exists in users'); return; }
      // Find current user record
      const curSnap = await getDocs(query(collection(AUTH_DB,'users'), where('email','==', cur)));
      if (curSnap.empty) { alert('User record not found for current email'); return; }
      await updateDoc(curSnap.docs[0].ref, { email: next, updatedAt: new Date().toISOString() });
      await updateDoc(item.ref, { status:'approved', handledAt: new Date().toISOString() });
    }
    async function denyEmailChange(item) { await updateDoc(item.ref, { status:'denied', handledAt: new Date().toISOString() }); }
    async function deleteEmailChange(item) { await deleteDoc(item.ref); }

    async function render() {
      setActiveTab();
      status.textContent = 'Loading‚Ä¶'; content.innerHTML='';
      const view = getView();

      if (view === '#hours') {
        const data = await loadWPRequests('hour_requests');
        for (const wp of WP_IDS) {
          const items = data[wp] || [];
          content.append(renderWPTable(`‚è≥ Hours ‚Äî ${wp}`, items, approveWP, denyWP, delWP));
        }
      } else if (view === '#timeoff') {
        const data = await loadWPRequests('time_off_requests');
        for (const wp of WP_IDS) content.append(renderWPTable(`üèñÔ∏è Time Off ‚Äî ${wp}`, data[wp]||[], approveWP, denyWP, delWP));
      } else if (view === '#shiftswap') {
        const data = await loadWPRequests('shift_swap_requests');
        for (const wp of WP_IDS) content.append(renderWPTable(`üîÅ Shift Swaps ‚Äî ${wp}`, data[wp]||[], approveWP, denyWP, delWP));
      } else if (view === '#emailchange') {
        const items = await loadEmailChangeRequests();
        content.append(renderWPTable('‚úâÔ∏è Email Change Requests (Auth DB)', items, approveEmailChange, denyEmailChange, deleteEmailChange));
      }

      status.textContent = 'Ready';
    }

    window.addEventListener('hashchange', () => { (async () => { if (await guardAdminOrRedirect()) render(); })(); });
    (async () => { if (await guardAdminOrRedirect()) render(); })();
  </script>
</body>
</html>
