<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Manage Workers (Admin)</title>
	<style>
		body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background:#f8f9fa; margin:0; }
		header { background:#111827; color:white; padding:1rem 1.5rem; display:flex; align-items:center; justify-content:space-between; }
		.tabs { display:flex; gap:.5rem; padding: .75rem 1rem; background:#fff; border-bottom:1px solid #e5e7eb; position:sticky; top:0; z-index:10; }
		.tab { padding:.5rem .75rem; border:1px solid #e5e7eb; background:#f9fafb; border-radius:8px; cursor:pointer; }
		.tab.active { background:#2563eb; color:white; border-color:#2563eb; }
		.container { max-width:1200px; margin:0 auto; padding:1rem; }
		table { width:100%; border-collapse:collapse; background:#fff; }
		th, td { padding:.5rem .75rem; border-bottom:1px solid #e5e7eb; text-align:left; }
		.toolbar { display:flex; gap:.5rem; margin:.75rem 0; }
		.btn { padding:.5rem .75rem; border:none; border-radius:8px; background:#374151; color:white; cursor:pointer; }
		.btn-primary { background:#2563eb; }
		.btn-danger { background:#b91c1c; }
		.pill { display:inline-block; padding:.15rem .45rem; border-radius:9999px; background:#e5e7eb; font-size:.75rem; }
		.status-ok { background:#bbf7d0; }
		.status-bad { background:#fecaca; }
		/* Modal styles */
		.modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:50; }
		.modal { width: min(720px, 92vw); background:#fff; border-radius:12px; box-shadow:0 20px 40px rgba(0,0,0,.25); overflow:hidden; }
		.modal header { background:#111827; color:#fff; padding:.75rem 1rem; display:flex; align-items:center; justify-content:space-between; }
		.modal .body { padding:1rem; }
		.form-grid { display:grid; grid-template-columns: 1fr 1fr; gap:.75rem .75rem; }
		.form-grid label { font-size:.85rem; color:#374151; }
		.form-grid input, .form-grid select, .form-grid textarea { width:100%; padding:.5rem; border:1px solid #e5e7eb; border-radius:8px; }
		.form-grid textarea { min-height: 80px; }
		.wp-group { display:flex; gap:1rem; flex-wrap:wrap; }
		.modal footer { padding: .75rem 1rem; display:flex; justify-content:flex-end; gap:.5rem; background:#f9fafb; border-top:1px solid #e5e7eb; }
	</style>
</head>
<body>
	<header>
		<h1 style="margin:0; font-size:1.1rem;">üë• Manage Workers</h1>
		<div>
			<a class="btn" href="dashboard.html">üè† Home</a>
		</div>
	</header>
	<div class="tabs">
		<button class="tab" data-tab="all">All Workers</button>
		<button class="tab" data-tab="esports_lounge">Lounge</button>
		<button class="tab" data-tab="esports_arena">Arena</button>
		<button class="tab" data-tab="it_service_center">IT Service Center</button>
		<button class="tab" data-tab="users">Users (Auth)</button>
	</div>
	<div class="container">
		<div id="status" class="pill">Loading‚Ä¶</div>
		<div id="content"></div>
	</div>

	<!-- Modal root -->
	<div id="mwModal" class="modal-overlay" aria-hidden="true">
		<div class="modal" role="dialog" aria-modal="true" aria-labelledby="mwModalTitle">
			<header>
				<h3 id="mwModalTitle" style="margin:0;font-size:1rem;">Add Worker</h3>
				<button id="mwCloseBtn" class="btn" style="background:#6b7280;">‚úï</button>
			</header>
			<div class="body">
				<div id="mwWpRow" style="margin-bottom:.5rem;">
					<label style="display:block;margin-bottom:.25rem;">Target workplace(s)</label>
					<div class="wp-group" id="mwWpGroup"></div>
				</div>
				<div class="form-grid">
					<div>
						<label>First name *</label>
						<input id="mwFirst" required />
					</div>
					<div>
						<label>Last name *</label>
						<input id="mwLast" required />
					</div>
					<div>
						<label>Email *</label>
						<input id="mwEmail" type="email" required />
					</div>
					<div>
						<label>Phone</label>
						<input id="mwPhone" />
					</div>
					<div>
						<label>F Number</label>
						<input id="mwFnum" />
					</div>
					<div>
						<label>Worker Type</label>
						<select id="mwType">
							<option value="Regular">Regular</option>
							<option value="Work Study">Work Study</option>
							<option value="Cover">Cover</option>
						</select>
					</div>
					<div>
						<label>Work Study (Yes/No)</label>
						<select id="mwWS"><option>No</option><option>Yes</option></select>
					</div>
					<div>
						<label>Pinned</label>
						<select id="mwPinned"><option>false</option><option>true</option></select>
					</div>
					<div style="grid-column:1/-1;">
						<label>Days & Times Available</label>
						<textarea id="mwAvail" placeholder="Mon 09:00-12:00, Tue 10:00-16:00 ..."></textarea>
					</div>
				</div>
			</div>
			<footer>
				<button id="mwCancel" class="btn" style="background:#6b7280;">Cancel</button>
				<button id="mwSave" class="btn btn-primary">Save</button>
			</footer>
		</div>
	</div>

	<script type="module" data-cfasync="false">
		import './firebase/config.js';
		import { getDBForWorkplace, AUTH_APP } from './firebase/config.js';
		import { guardAdminOrRedirect, isAdminUser, setAdmin } from './JS/admin-status.js';
		import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc, query, where } from 'https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js';
		import { addWorker, updateWorker, deleteWorker } from './JS/worker-CRUD.js';

		// avoid top-level return (breaks with Rocket Loader); gate init via async IIFE
		const currentUser = JSON.parse(localStorage.getItem('user')||'{}');

		const authDb = getFirestore(AUTH_APP);
		const tabs = document.querySelectorAll('.tab');
		const status = document.getElementById('status');
		const content = document.getElementById('content');
		const params = new URLSearchParams(location.search);
		let currentTab = params.get('wp') || 'all';

		const WP_IDS = ['esports_lounge','esports_arena','it_service_center'];

		function h(tag, attrs={}, children=[]) {
			const e=document.createElement(tag); Object.entries(attrs).forEach(([k,v])=>{ if(k==='html') e.innerHTML=v; else e.setAttribute(k,v); });
			(Array.isArray(children)?children:[children]).forEach(c=>e.appendChild(typeof c==='string'?document.createTextNode(c):c)); return e;
		}

		tabs.forEach(t=>{
			t.onclick = ()=> { currentTab = t.dataset.tab; render(); tabs.forEach(x=>x.classList.toggle('active', x===t)); };
			if (t.dataset.tab === currentTab) t.classList.add('active');
		});

		async function fetchWorkersFor(wp) {
			const db = getDBForWorkplace(wp);
			const snap = await getDocs(collection(db, 'workers'));
			return snap.docs.map(d=>({ id:d.id, ...d.data(), __wp: wp }));
		}

		async function fetchAllWorkers() {
			const all = [];
			for (const id of WP_IDS) all.push(...await fetchWorkersFor(id));
			return all;
		}

		async function fetchUsers() {
			const snap = await getDocs(collection(authDb, 'users'));
			return snap.docs.map(d => ({ id:d.id, ...d.data() }));
		}

		function joinWorkersUsers(workers, users) {
			const byEmail = new Map(users.map(u=>[String(u.email||'').toLowerCase(), u]));
			return workers.map(w=>({ ...w, __user: byEmail.get(String(w['Email']||'').toLowerCase()) || null }));
		}

		function renderWorkersTable(rows, { allowCrud=true }={}) {
			if (!rows || rows.length === 0) {
				const wrap = h('div');
				wrap.append(h('div', { class:'pill' }, 'No workers added'));
				return wrap;
			}
			const table = h('table');
			const thead = h('thead', { html: `<tr><th>WP</th><th>First</th><th>Last</th><th>Email</th><th>Type</th><th>User Admin</th><th>Actions</th></tr>` });
			table.appendChild(thead);
			const tbody = h('tbody');
			for (const r of rows) {
				const tr = h('tr');
				const isAdmin = r.__user && (r.__user.isAdmin===1 || r.__user.isAdmin===true);
				tr.innerHTML = `
					<td>${r.__wp||''}</td>
					<td>${r['First Name']||''}</td>
					<td>${r['Last Name']||''}</td>
					<td>${r['Email']||''}</td>
					<td>${r['Worker Type']||''}</td>
					<td><span class="pill ${isAdmin?'status-ok':'status-bad'}">${isAdmin?'Admin':'User'}</span></td>
					<td></td>`;
				const cell = tr.querySelector('td:last-child');
				if (allowCrud) {
					const be = h('button', { class:'btn' }, 'Edit'); be.onclick = async ()=>{
						const data = await promptEditWorker(r); if (!data) return; await updateWorker(getDBForWorkplace(r.__wp), r.id, data); await render(); };
					const bd = h('button', { class:'btn btn-danger' }, 'Delete'); bd.onclick = async ()=>{ if (!confirm('Delete worker?')) return; await deleteWorker(getDBForWorkplace(r.__wp), r.id); await render(); };
					cell.append(be, bd);
				}
				tbody.appendChild(tr);
			}
			table.appendChild(tbody);
			return table;
		}

		function renderUsersTable(rows) {
			const table = h('table');
			table.appendChild(h('thead',{ html:`<tr><th>First</th><th>Last</th><th>Email</th><th>Phone</th><th>Admin</th><th>Actions</th></tr>` }));
			const tbody = h('tbody');
			rows.forEach(u=>{
				const tr = h('tr'); const isA = (u.isAdmin===1||u.isAdmin===true);
				tr.innerHTML = `
					<td>${u.firstName||''}</td>
					<td>${u.lastName||''}</td>
					<td>${u.email||''}</td>
					<td>${u.phone||''}</td>
					<td><span class="pill ${isA?'status-ok':'status-bad'}">${isA?'Admin':'User'}</span></td>
					<td></td>`;
				const cell = tr.querySelector('td:last-child');
				const toggle = h('button', { class:'btn' }, isA ? 'Revoke Admin' : 'Make Admin');
				toggle.onclick = async ()=>{ await setAdmin(u.email, !isA); await render(); };
				cell.append(toggle);
				tbody.appendChild(tr);
			});
			table.appendChild(tbody); return table;
		}


		function yesNoToBool(val, fallback=false) {
			if (typeof val === 'boolean') return val; if (val==null) return fallback;
			const s = String(val).toLowerCase(); return s==='yes'||s==='true'||s==='1';
		}

		function labelForWp(id){ return id==='esports_lounge'?'Lounge':id==='esports_arena'?'Arena':'IT Service Center'; }

		function openWorkerModal({ mode='add', preselectWps=[], worker={} }={}) {
			return new Promise(resolve => {
				const overlay = document.getElementById('mwModal');
				const title = document.getElementById('mwModalTitle');
				const wpGroup = document.getElementById('mwWpGroup');
				const wpRow = document.getElementById('mwWpRow');
				const el = {
					first: document.getElementById('mwFirst'),
					last: document.getElementById('mwLast'),
					email: document.getElementById('mwEmail'),
					phone: document.getElementById('mwPhone'),
					fnum: document.getElementById('mwFnum'),
					type: document.getElementById('mwType'),
					ws: document.getElementById('mwWS'),
					pinned: document.getElementById('mwPinned'),
					avail: document.getElementById('mwAvail')
				};
				// Reset fields
				el.first.value = worker['First Name']||'';
				el.last.value = worker['Last Name']||'';
				el.email.value = worker['Email']||'';
				el.phone.value = worker['Phone Number']||worker['Phone']||'';
				el.fnum.value = worker['F Number']||worker['FNumber']||'';
				el.type.value = worker['Worker Type']||'Regular';
				el.ws.value = worker['Work Study']||'No';
				el.pinned.value = String(worker.isPinned!=null?worker.isPinned:false);
				el.avail.value = worker['Days & Times Available']||worker['Availability']||'';
				// Build wp checkboxes
				wpGroup.innerHTML = '';
				WP_IDS.forEach(id=>{
					const idAttr = `mw-wp-${id}`;
					const lab = document.createElement('label'); lab.style.display='flex'; lab.style.alignItems='center'; lab.style.gap='.35rem';
					const cb = document.createElement('input'); cb.type='checkbox'; cb.value=id; cb.id=idAttr; cb.checked = preselectWps.includes(id);
					lab.append(cb, document.createTextNode(labelForWp(id))); wpGroup.append(lab);
				});
				// If editing, hide wp selection (editing in-place)
				wpRow.style.display = mode==='edit' ? 'none' : '';
				title.textContent = mode==='edit' ? 'Edit Worker' : 'Add Worker';
				// Wire buttons
				const close = () => { overlay.style.display='none'; resolve(null); };
				document.getElementById('mwCloseBtn').onclick = close;
				document.getElementById('mwCancel').onclick = close;
				document.getElementById('mwSave').onclick = () => {
					// Validate
					const first = el.first.value.trim(); const last = el.last.value.trim(); const email = el.email.value.trim();
					if (!first || !last || !email) { alert('First, Last, and Email are required'); return; }
					const data = {
						'First Name': first,
						'Last Name': last,
						'Email': email,
						'Phone Number': el.phone.value.trim(),
						'Phone': el.phone.value.trim(),
						'F Number': el.fnum.value.trim(),
						'Worker Type': el.type.value,
						'Work Study': el.ws.value,
						'Days & Times Available': el.avail.value,
						'Availability': el.avail.value,
						isPinned: (el.pinned.value === 'true')
					};
					const selectedWps = Array.from(wpGroup.querySelectorAll('input[type="checkbox"]:checked')).map(c=>c.value);
					overlay.style.display='none';
					resolve({ data, workplaces: selectedWps });
				};
				overlay.style.display='flex';
			});
		}

		async function render() {
			status.textContent = 'Loading‚Ä¶'; content.innerHTML = '';
			try {
				if (currentTab === 'users') {
					const users = await fetchUsers();
					content.appendChild(renderUsersTable(users));
					status.textContent = `Users: ${users.length}`; return;
				}
				if (currentTab === 'all') {
					const [workers, users] = [await fetchAllWorkers(), await fetchUsers()];
					const joined = joinWorkersUsers(workers, users);
					const toolbar = h('div', { class:'toolbar' });
					const add = h('button', { class:'btn btn-primary' }, 'Add Worker');
					add.onclick = async ()=>{
						const result = await openWorkerModal({ mode:'add', preselectWps: WP_IDS });
						if (!result) return;
						const { data, workplaces } = result;
						if (!workplaces || workplaces.length===0) { alert('Choose at least one workplace'); return; }
						const payload = { ...data, created_at: new Date().toISOString(), created_by: currentUser?.email||'system' };
						await Promise.all(workplaces.map(wp => addWorker(getDBForWorkplace(wp), payload)));
						await render();
					};
					toolbar.append(add);
					content.append(toolbar);
					content.appendChild(renderWorkersTable(joined));
					status.textContent = `All workers: ${joined.length}`; return;
				}
				// Workplace-specific tabs
				if (WP_IDS.includes(currentTab)) {
					const [rows, users] = [await fetchWorkersFor(currentTab), await fetchUsers()];
					const joined = joinWorkersUsers(rows, users);
					const toolbar = h('div', { class:'toolbar' });
					const add = h('button', { class:'btn btn-primary' }, 'Add Worker');
					add.onclick = async ()=>{
						const result = await openWorkerModal({ mode:'add', preselectWps:[currentTab] });
						if (!result) return; const { data, workplaces } = result;
						const targets = (workplaces && workplaces.length>0) ? workplaces : [currentTab];
						const payload = { ...data, created_at: new Date().toISOString(), created_by: currentUser?.email||'system' };
						await Promise.all(targets.map(wp => addWorker(getDBForWorkplace(wp), payload)));
						await render();
					};
					toolbar.append(add);
					content.append(toolbar);
					content.appendChild(renderWorkersTable(joined));
					status.textContent = `${currentTab} workers: ${joined.length}`; return;
				}
			} catch (e) {
				status.textContent = e.message; status.classList.add('status-bad');
			}
		}

		// Start after admin check to avoid top-level return
		(async () => { if (await guardAdminOrRedirect()) { await render(); } })();
	</script>
</body>
</html>
