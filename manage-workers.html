<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Manage Workers (Admin)</title>
	<style>
		body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background:#f8f9fa; margin:0; }
		header { background:#111827; color:white; padding:1rem 1.5rem; display:flex; align-items:center; justify-content:space-between; }
		.tabs { display:flex; gap:.5rem; padding: .75rem 1rem; background:#fff; border-bottom:1px solid #e5e7eb; position:sticky; top:0; z-index:10; }
		.tab { padding:.5rem .75rem; border:1px solid #e5e7eb; background:#f9fafb; border-radius:8px; cursor:pointer; }
		.tab.active { background:#2563eb; color:white; border-color:#2563eb; }
		.container { max-width:1200px; margin:0 auto; padding:1rem; }
		table { width:100%; border-collapse:collapse; background:#fff; }
		th, td { padding:.5rem .75rem; border-bottom:1px solid #e5e7eb; text-align:left; }
		.toolbar { display:flex; gap:.5rem; margin:.75rem 0; }
		.btn { padding:.5rem .75rem; border:none; border-radius:8px; background:#374151; color:white; cursor:pointer; }
		.btn-primary { background:#2563eb; }
		.btn-danger { background:#b91c1c; }
		.pill { display:inline-block; padding:.15rem .45rem; border-radius:9999px; background:#e5e7eb; font-size:.75rem; }
		.status-ok { background:#bbf7d0; }
		.status-bad { background:#fecaca; }
		/* Modal styles */
		.modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:50; padding: 1rem; }
		.modal { width: min(720px, 92vw); max-height: 92vh; background:#fff; border-radius:12px; box-shadow:0 20px 40px rgba(0,0,0,.25); overflow:hidden; display:flex; flex-direction:column; }
		.modal header { background:#111827; color:#fff; padding:.75rem 1rem; display:flex; align-items:center; justify-content:space-between; flex: 0 0 auto; }
		.modal .body { padding:1rem; overflow:auto; flex: 1 1 auto; }
		.form-grid { display:grid; grid-template-columns: 1fr 1fr; gap:.75rem .75rem; }
		.form-grid label { font-size:.85rem; color:#374151; }
		.form-grid input, .form-grid select, .form-grid textarea { width:100%; padding:.5rem; border:1px solid #e5e7eb; border-radius:8px; }
		.form-grid textarea { min-height: 80px; }
		.wp-group { display:flex; gap:1rem; flex-wrap:wrap; }
		.modal footer { padding: .75rem 1rem; display:flex; justify-content:flex-end; gap:.5rem; background:#f9fafb; border-top:1px solid #e5e7eb; }
	</style>
	<link rel="stylesheet" href="./theme/theme-toggle-per-user.css" />
</head>
<body>
	<script type="module" src="./theme/theme-toggle-per-user.js"></script>
	<header>
		<h1 style="margin:0; font-size:1.1rem;">üë• Manage Workers</h1>
		<div>
			<a class="btn" href="dashboard.html">üè† Home</a>
		</div>
	</header>
	<div class="tabs">
		<button class="tab" data-tab="all">All Workers</button>
		<button class="tab" data-tab="esports_lounge">Lounge</button>
		<button class="tab" data-tab="esports_arena">Arena</button>
		<button class="tab" data-tab="it_service_center">IT Service Center</button>
		<button class="tab" data-tab="users">Users (Auth)</button>
	</div>
	<div class="container">
		<div id="status" class="pill">Loading‚Ä¶</div>
		<div id="content"></div>
	</div>

	<!-- Modal root -->
	<div id="mwModal" class="modal-overlay" aria-hidden="true">
		<div class="modal" role="dialog" aria-modal="true" aria-labelledby="mwModalTitle">
			<header>
				<h3 id="mwModalTitle" style="margin:0;font-size:1rem;">Add Worker</h3>
				<button id="mwCloseBtn" class="btn" style="background:#6b7280;">‚úï</button>
			</header>
			<div class="body">
				<div id="mwWpRow" style="margin-bottom:.5rem;">
					<label style="display:block;margin-bottom:.25rem;">Target workplace(s)</label>
					<div class="wp-group" id="mwWpGroup"></div>
				</div>
				<div class="form-grid">
					<div>
						<label>First name *</label>
						<input id="mwFirst" required />
					</div>
					<div>
						<label>Last name *</label>
						<input id="mwLast" required />
					</div>
					<div>
						<label>Email *</label>
						<input id="mwEmail" type="email" required />
					</div>
					<div>
						<label>Phone</label>
						<input id="mwPhone" />
					</div>
					<div>
						<label>F Number</label>
						<input id="mwFnum" />
					</div>
					<!-- Removed legacy Worker Type selector; Work Study boolean is canonical -->
					<div>
						<label>Work Study (Yes/No)</label>
						<select id="mwWS"><option>No</option><option>Yes</option></select>
					</div>
					<div>
						<label>Pinned</label>
						<select id="mwPinned"><option>false</option><option>true</option></select>
					</div>
					<div>
						<label>Suspended</label>
						<select id="mwSuspended"><option>false</option><option>true</option></select>
					</div>
					<div style="grid-column:1/-1;">
						<label>Availability</label>
						<!-- Mode toggle -->
						<div style="display:flex;gap:.5rem;align-items:center;margin:.25rem 0 .5rem 0;flex-wrap:wrap;">
							<span style="font-size:.85rem;color:#374151">Input mode:</span>
							<div class="pill" id="mwModeFree" style="cursor:pointer;background:#e5e7eb;">Free text</div>
							<div class="pill" id="mwModeEditor" style="cursor:pointer;background:#2563eb;color:#fff;">Day & time editor</div>
							<span style="margin-left:1rem;font-size:.85rem;color:#374151">Time format:</span>
							<div class="pill" id="mwFmt24" style="cursor:pointer;background:#2563eb;color:#fff;">24h</div>
							<div class="pill" id="mwFmtAmPm" style="cursor:pointer;background:#e5e7eb;">AM/PM</div>
						</div>

						<!-- Free text textarea (legacy compatible) -->
						<textarea id="mwAvail" placeholder="Mon 09:00-12:00, Tue 10:00-16:00 ..." style="display:none;"></textarea>

						<!-- Structured editor -->
						<div id="mwAvailEditor" style="border:1px solid #e5e7eb;border-radius:8px;padding:.5rem;">
							<div id="mwDays"></div>
							<div style="margin-top:.5rem;color:#6b7280;font-size:.85rem;">Tip: Add one or more time ranges per day. We'll store a single Availability string like "Mon 09:00-12:00, Tue 10:00-16:00".</div>
						</div>
					</div>
				</div>
			</div>
			<footer>
				<button id="mwCancel" class="btn" style="background:#6b7280;">Cancel</button>
				<button id="mwSave" class="btn btn-primary">Save</button>
			</footer>
		</div>
	</div>

	<script type="module" data-cfasync="false">
		import './firebase/config.js';
		import { getDBForWorkplace, AUTH_APP } from './firebase/config.js';
		import { guardAdminOrRedirect, isAdminUser, setAdmin } from './JS/admin-status.js';
		import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc, query, where, deleteField } from 'https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js';
		import { addWorker, updateWorker, deleteWorker } from './JS/worker-CRUD.js';

		// avoid top-level return (breaks with Rocket Loader); gate init via async IIFE
		const currentUser = JSON.parse(localStorage.getItem('user')||'{}');

		const authDb = getFirestore(AUTH_APP);
		const tabs = document.querySelectorAll('.tab');
		const status = document.getElementById('status');
		const content = document.getElementById('content');
		const params = new URLSearchParams(location.search);
		let currentTab = params.get('wp') || 'all';

		// UI state for search/sort per tab (persist via localStorage)
		const UI_STATE_KEY = 'wm_ui_state_v1';
		const uiState = { searchTextByTab: {}, nameViewByTab: {} };
		const defaultNameView = 'first-last'; // or 'last-first'
		function loadUiState(){
			try {
				const raw = localStorage.getItem(UI_STATE_KEY);
				if (!raw) return;
				const s = JSON.parse(raw);
				if (s && typeof s === 'object') {
					uiState.searchTextByTab = s.searchTextByTab || {};
					uiState.nameViewByTab = s.nameViewByTab || {};
				}
			} catch {}
		}
		function persistUiState(){
			try {
				localStorage.setItem(UI_STATE_KEY, JSON.stringify({
					searchTextByTab: uiState.searchTextByTab,
					nameViewByTab: uiState.nameViewByTab
				}));
			} catch {}
		}

		const WP_IDS = ['esports_lounge','esports_arena','it_service_center'];

		function h(tag, attrs={}, children=[]) {
			const e=document.createElement(tag); Object.entries(attrs).forEach(([k,v])=>{ if(k==='html') e.innerHTML=v; else e.setAttribute(k,v); });
			(Array.isArray(children)?children:[children]).forEach(c=>e.appendChild(typeof c==='string'?document.createTextNode(c):c)); return e;
		}

		tabs.forEach(t=>{
			t.onclick = ()=> { currentTab = t.dataset.tab; render(); tabs.forEach(x=>x.classList.toggle('active', x===t)); };
			if (t.dataset.tab === currentTab) t.classList.add('active');
		});

		// Load persisted UI state once on startup
		loadUiState();

		async function fetchWorkersFor(wp) {
			const db = getDBForWorkplace(wp);
			const snap = await getDocs(collection(db, 'workers'));
			return snap.docs.map(d=>({ id:d.id, ...d.data(), __wp: wp }));
		}

		async function fetchAllWorkers() {
			const all = [];
			for (const id of WP_IDS) all.push(...await fetchWorkersFor(id));
			return all;
		}

		async function fetchWorkerInstancesByEmail(email) {
			const results = [];
			for (const wp of WP_IDS) {
				const db = getDBForWorkplace(wp);
				const snap = await getDocs(query(collection(db,'workers'), where('Email','==', email)));
				snap.docs.forEach(d=> results.push({ wp, id:d.id, data:d.data() }));
			}
			return results;
		}

		async function fetchUsers() {
			const snap = await getDocs(collection(authDb, 'users'));
			return snap.docs.map(d => ({ id:d.id, ...d.data() }));
		}

		function joinWorkersUsers(workers, users) {
			const byEmail = new Map(users.map(u=>[String(u.email||'').toLowerCase(), u]));
			return workers.map(w=>({ ...w, __user: byEmail.get(String(w['Email']||'').toLowerCase()) || null }));
		}

		function aggregateByEmail(workers) {
			const map = new Map();
			for (const w of workers) {
				const key = String(w['Email']||'').toLowerCase();
				if (!map.has(key)) map.set(key, { ...w, __wps: [w.__wp].filter(Boolean), __wp: undefined });
				else map.get(key).__wps.push(w.__wp);
			}
			return Array.from(map.values());
		}

		function normalize(str){ return String(str||'').trim().toLowerCase(); }
		function compareStr(a,b){ return a.localeCompare(b, undefined, { sensitivity:'base' }); }
		function getNameParts(row){
			return {
				first: String(row['First Name']||row.firstName||'').trim(),
				last: String(row['Last Name']||row.lastName||'').trim()
			};
		}

		// Human-friendly labels for workplace IDs
		function labelForWp(id){
			switch(id){
				case 'esports_lounge': return 'Lounge';
				case 'esports_arena': return 'Arena';
				case 'it_service_center': return 'IT Service Center';
				default: return id || '';
			}
		}

		function workerMatchesSimple(row, q){
			const query = normalize(q);
			if (!query) return true;
			const {first, last} = getNameParts(row);
			const name = `${normalize(first)} ${normalize(last)}`.trim();
			const email = normalize(row['Email']||'');
			return name.includes(query) || email.includes(query);
		}

		function userMatchesSimple(u, q){
			const query = normalize(q);
			if (!query) return true;
			const name = `${normalize(u.firstName)} ${normalize(u.lastName)}`.trim();
			const email = normalize(u.email);
			return name.includes(query) || email.includes(query);
		}

		function filterAndSortWorkers(rows, searchText, nameView){
			const q = searchText || '';
			let filtered = rows;
			if (normalize(q)) {
				filtered = rows.filter(r=> workerMatchesSimple(r, q));
			}
			const view = nameView || defaultNameView;
			filtered.sort((a,b)=>{
				const A = getNameParts(a); const B = getNameParts(b);
				if (view==='last-first') {
					const c = compareStr(A.last, B.last); if (c!==0) return c; return compareStr(A.first, B.first);
				} else {
					const c = compareStr(A.first, B.first); if (c!==0) return c; return compareStr(A.last, B.last);
				}
			});
			return filtered;
		}

		function filterAndSortUsers(rows, searchText, nameView){
			const q = searchText || '';
			let filtered = rows;
			if (normalize(q)) {
				filtered = rows.filter(u=> userMatchesSimple(u, q));
			}
			const view = nameView || defaultNameView;
			filtered.sort((a,b)=>{
				if (view==='last-first') {
					const c = compareStr(a.lastName||'', b.lastName||''); if (c!==0) return c; return compareStr(a.firstName||'', b.firstName||'');
				} else {
					const c = compareStr(a.firstName||'', b.firstName||''); if (c!==0) return c; return compareStr(a.lastName||'', b.lastName||'');
				}
			});
			return filtered;
		}

		function commitSearch(tabKey, value){
			uiState.searchTextByTab[tabKey] = value;
			persistUiState();
			render();
		}

		function buildSearchAndSortToolbar({ onAdd=null, tabKey }){
			const wrap = h('div', { class:'toolbar' });
			const search = document.createElement('input');
			search.placeholder = 'Search name or email‚Ä¶';
			search.value = uiState.searchTextByTab[tabKey] || '';
			search.style.flex = '1 1 260px';
			search.style.minWidth = '180px';
			// Simplified: commit on Enter or Search button only
			search.oninput = ()=>{};
			search.onkeyup = (e)=>{ if (e.key==='Enter') commitSearch(tabKey, search.value); };

			const sortWrap = document.createElement('div'); sortWrap.style.display='flex'; sortWrap.style.gap='.35rem'; sortWrap.style.alignItems='center';
			const lbl = document.createElement('span'); lbl.style.fontSize='.85rem'; lbl.style.color='#374151'; lbl.textContent='Name view:';
			const pillFirst = h('div', { class:'pill' }, 'First, Last'); pillFirst.style.cursor='pointer';
			const pillLast = h('div', { class:'pill' }, 'Last, First'); pillLast.style.cursor='pointer';
			const setViewUI = ()=>{
				const v = uiState.nameViewByTab[tabKey] || defaultNameView;
				const on = (el,active)=>{ el.style.background = active?'#2563eb':'#e5e7eb'; el.style.color = active?'#fff':'#111827'; };
				on(pillFirst, v==='first-last'); on(pillLast, v==='last-first');
			};
			pillFirst.onclick = ()=>{ uiState.nameViewByTab[tabKey] = 'first-last'; persistUiState(); setViewUI(); render(); };
			pillLast.onclick = ()=>{ uiState.nameViewByTab[tabKey] = 'last-first'; persistUiState(); setViewUI(); render(); };
			setViewUI();
			sortWrap.append(lbl, pillFirst, pillLast);

			const doSearchBtn = h('button', { class:'btn' }, 'Search');
			doSearchBtn.onclick = ()=> commitSearch(tabKey, search.value);
			const clearBtn = h('button', { class:'btn' }, 'Clear');
			clearBtn.onclick = ()=>{ search.value=''; commitSearch(tabKey, ''); };

			if (onAdd) {
				const addBtn = h('button', { class:'btn btn-primary' }, 'Add Worker');
				addBtn.onclick = onAdd; wrap.append(addBtn);
			}
			wrap.append(search, doSearchBtn, clearBtn, sortWrap);
			return wrap;
		}

		function renderWorkersTable(rows, { allowCrud=true, showAllEdit=false }={}) {
			if (!rows || rows.length === 0) {
				const wrap = h('div');
				wrap.append(h('div', { class:'pill' }, 'No workers added'));
				return wrap;
			}
			const table = h('table');
			const thead = h('thead', { html: `<tr><th>WP</th><th>First</th><th>Last</th><th>Email</th><th>Work Study</th><th>User Admin</th><th>Actions</th></tr>` });
			table.appendChild(thead);
			const tbody = h('tbody');
			for (const r of rows) {
				const tr = h('tr');
				const isAdmin = r.__user && (r.__user.isAdmin===1 || r.__user.isAdmin===true);
				const wpCell = Array.isArray(r.__wps) ? r.__wps.join(', ') : (r.__wp||'');
				// Determine Work Study via canonical boolean or legacy fields
				const wsBool = (r.workStudy===true) || String(r['Work Study']||'').toLowerCase()==='yes' || String(r['Worker Type']||'').toLowerCase()==='work study';
				tr.innerHTML = `
					<td>${wpCell}</td>
					<td>${r['First Name']||''}</td>
					<td>${r['Last Name']||''}</td>
					<td>${r['Email']||''}</td>
					<td>${wsBool ? 'Yes' : 'No'}</td>
					<td><span class="pill ${isAdmin?'status-ok':'status-bad'}">${isAdmin?'Admin':'User'}</span></td>
					<td></td>`;
				const cell = tr.querySelector('td:last-child');
				if (Array.isArray(r.__wps) && showAllEdit) {
					const beAll = h('button', { class:'btn' }, 'Edit (All WPs)');
					beAll.onclick = async ()=>{
						const email = r['Email'];
						const instances = await fetchWorkerInstancesByEmail(email);
						if (!instances || instances.length===0) { alert('No worker instances found'); return; }
						const wps = instances.map(i=>i.wp);
						const base = { ...instances[0].data };
						const perPrefill = Object.fromEntries(instances.map(i=>[i.wp, i.data['Availability']||'']));
						const result = await openWorkerModal({ mode:'edit', preselectWps:wps, worker:base, forcePerWpEditors:true, perWpPrefill: perPrefill });
						if (!result) return; const { data, perWpAvail } = result;
						for (const inst of instances) {
							const dbSel = getDBForWorkplace(inst.wp);
							const payload = { ...data, 'Availability': (perWpAvail && perWpAvail[inst.wp]) || data['Availability'] };
							await updateWorker(dbSel, inst.id, payload);
						}
						await render();
					};
					cell.append(beAll);
				} else if (allowCrud && !Array.isArray(r.__wps)) {
					const be = h('button', { class:'btn' }, 'Edit'); be.onclick = async ()=>{
						const result = await openWorkerModal({ mode:'edit', preselectWps:[r.__wp].filter(Boolean), worker:r }); if (!result) return; const { data } = result; 
						const dbSel = getDBForWorkplace(r.__wp);
						await updateWorker(dbSel, r.id, data);
						// Remove legacy field if present
						try { await updateDoc(doc(dbSel, 'workers', r.id), { 'Days & Times Available': deleteField() }); } catch(e) { /* ignore if not present */ }
						await render(); };
					const bd = h('button', { class:'btn btn-danger' }, 'Delete'); bd.onclick = async ()=>{ if (!confirm('Delete worker?')) return; await deleteWorker(getDBForWorkplace(r.__wp), r.id); await render(); };
					cell.append(be, bd);
				}
					tbody.appendChild(tr);
				}
				table.appendChild(tbody);
				return table;
			}

						function renderUsersTable(rows) {
						const table = h('table');
						table.appendChild(h('thead',{ html:`<tr><th>First</th><th>Last</th><th>Email</th><th>Phone</th><th>Admin</th><th>Actions</th></tr>` }));
						const tbody = h('tbody');
						rows.forEach(u=>{
							const tr = h('tr'); const isA = (u.isAdmin===1||u.isAdmin===true);
							tr.innerHTML = `
								<td>${u.firstName||''}</td>
								<td>${u.lastName||''}</td>
								<td>${u.email||''}</td>
								<td>${u.phone||''}</td>
								<td><span class="pill ${isA?'status-ok':'status-bad'}">${isA?'Admin':'User'}</span></td>
								<td></td>`;
							const cell = tr.querySelector('td:last-child');
							const toggle = h('button', { class:'btn' }, isA ? 'Revoke Admin' : 'Make Admin');
							toggle.onclick = async ()=>{ await setAdmin(u.email, !isA); await render(); };
							cell.append(toggle);
							tbody.appendChild(tr);
						});
						table.appendChild(tbody); return table;
					}

					function openWorkerModal({ mode='add', preselectWps=[], worker={}, forcePerWpEditors=false, perWpPrefill=null }={}) {
			return new Promise(resolve => {
				const overlay = document.getElementById('mwModal');
				const title = document.getElementById('mwModalTitle');
				const wpGroup = document.getElementById('mwWpGroup');
				const wpRow = document.getElementById('mwWpRow');
				const el = {
					first: document.getElementById('mwFirst'),
					last: document.getElementById('mwLast'),
					email: document.getElementById('mwEmail'),
					phone: document.getElementById('mwPhone'),
					fnum: document.getElementById('mwFnum'),
					ws: document.getElementById('mwWS'),
					suspended: document.getElementById('mwSuspended'),
					pinned: document.getElementById('mwPinned'),
					avail: document.getElementById('mwAvail'),
					availEditor: document.getElementById('mwAvailEditor'),
					daysWrap: document.getElementById('mwDays'),
					modeFree: document.getElementById('mwModeFree'),
					modeEditor: document.getElementById('mwModeEditor'),
					fmt24: document.getElementById('mwFmt24'),
					fmtAmPm: document.getElementById('mwFmtAmPm')
				};

				// Create/attach container for per-workplace editors just below the availability section
				let perWpEditorsWrap = document.getElementById('mwPerWpEditors');
				if (!perWpEditorsWrap) { perWpEditorsWrap = document.createElement('div'); perWpEditorsWrap.id='mwPerWpEditors'; perWpEditorsWrap.style.marginTop='.5rem'; el.availEditor.parentElement.appendChild(perWpEditorsWrap); }
				// Always clear any previous editors from prior modal sessions to avoid state bleed
				perWpEditorsWrap.innerHTML = '';
				el.perWpEditorsWrap = perWpEditorsWrap;

				// local editor state (avoid name clash with function arg)
				const isEditParam = (mode === 'edit');
				let inputMode = 'editor'; // 'editor' | 'free'
				let timeFormat = '24h'; // '24h' | 'ampm'
				const DAYS = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
				const ABBR = { Sunday:'Sun', Monday:'Mon', Tuesday:'Tue', Wednesday:'Wed', Thursday:'Thu', Friday:'Fri', Saturday:'Sat' };

				function minutes(h, m) { return h*60 + m; }
				function to24h(h, m, ap) {
					let hh = parseInt(h,10)||0; let mm = parseInt(m,10)||0; const apL = (ap||'').toLowerCase();
					if (apL==='pm' && hh<12) hh+=12; if (apL==='am' && hh===12) hh=0; return minutes(hh, mm);
				}
				function fmtHM(mins) { const h=Math.floor(mins/60); const mm=(mins%60).toString().padStart(2,'0'); return `${h.toString().padStart(2,'0')}:${mm}`; }
				function fmtAMPM(mins) { const h=Math.floor(mins/60); const mm=(mins%60).toString().padStart(2,'0'); const ap=h>=12?'PM':'AM'; const hh=(h%12)||12; return `${hh}:${mm} ${ap}`; }

				function makeTimeInputs(defaultStart=540, defaultEnd=1020) {
					const wrap = document.createElement('div'); wrap.style.display='flex'; wrap.style.gap='.35rem'; wrap.style.alignItems='center';
					wrap.style.margin='.25rem 0';
					function build24(val) { const inp=document.createElement('input'); inp.type='time'; inp.step=300; inp.value=val; inp.style.padding='.3rem'; inp.style.border='1px solid #e5e7eb'; inp.style.borderRadius='6px'; return inp; }
					function buildAP(val) {
						const [labelH,labelM,labelAP] = (()=>{ const h=Math.floor(defaultStart/60); const m=(defaultStart%60).toString().padStart(2,'0'); return [((h%12)||12), m, h>=12?'PM':'AM']; })();
						const makeSel=(opts)=>{ const s=document.createElement('select'); s.style.padding='.3rem'; s.style.border='1px solid #e5e7eb'; s.style.borderRadius='6px'; opts.forEach(o=>{ const opt=document.createElement('option'); opt.value=o; opt.textContent=o; s.appendChild(opt); }); return s; };
						const sh=makeSel([...Array(12)].map((_,i)=>String(i+1))); const sm=makeSel(['00','15','30','45']); const sap=makeSel(['AM','PM']);
						const eh=makeSel([...Array(12)].map((_,i)=>String(i+1))); const em=makeSel(['00','15','30','45']); const eap=makeSel(['AM','PM']);
						// initialize from val strings if provided
						const [sv='09:00', ev='17:00'] = [fmtHM(defaultStart), fmtHM(defaultEnd)];
						function setFromHM(selH, selM, selAP, hm) { const [h,m]=hm.split(':').map(Number); selH.value=String(((h%12)||12)); selM.value=(m+'').padStart(2,'0'); selAP.value=h>=12?'PM':'AM'; }
						setFromHM(sh, sm, sap, sv); setFromHM(eh, em, eap, ev);
						return { sh, sm, sap, eh, em, eap, render(){ const g=document.createElement('div'); g.style.display='flex'; g.style.gap='.25rem'; g.append(sh,document.createTextNode(':'),sm,sap,document.createTextNode(' - '),eh,document.createTextNode(':'),em,eap); return g; },
						get(){ return { start: to24h(sh.value, sm.value, sap.value), end: to24h(eh.value, em.value, eap.value) }; } };
					}
					if (timeFormat==='24h') {
						const s=build24(fmtHM(defaultStart)); const e=build24(fmtHM(defaultEnd));
						wrap.append(s, document.createTextNode(' - '), e);
						return { element:wrap, get(){ const [sh,sm]=s.value.split(':').map(Number); const [eh,em]=e.value.split(':').map(Number); return { start: minutes(sh,sm), end: minutes(eh,em) }; } };
					} else {
						const ap=buildAP(); const el=ap.render(); wrap.append(el); return { element:wrap, get(){ return ap.get(); } };
					}
				}

				function renderDaysEditor(state) {
					el.daysWrap.innerHTML='';
					DAYS.forEach(day=>{
						const sec=document.createElement('div'); sec.style.borderTop='1px solid #e5e7eb'; sec.style.padding='.5rem 0';
						const head=document.createElement('div'); head.style.display='flex'; head.style.justifyContent='space-between'; head.style.alignItems='center';
						head.innerHTML = `<strong>${day}</strong>`;
						const addBtn=document.createElement('button'); addBtn.className='btn'; addBtn.textContent='Add time'; addBtn.style.padding='.25rem .5rem'; addBtn.style.fontSize='.85rem';
						const list=document.createElement('div');
						list.style.marginTop='.35rem';
						function addRow(range){
							const row=document.createElement('div'); row.className='mw-row'; row.style.display='flex'; row.style.gap='.5rem'; row.style.alignItems='center';
							const ti=makeTimeInputs(range?range.start:540, range?range.end:1020);
							const del=document.createElement('button'); del.className='btn btn-danger'; del.textContent='Remove'; del.style.padding='.25rem .5rem'; del.style.fontSize='.8rem';
							del.onclick=()=>{ row.remove(); };
							row.append(ti.element, del); list.append(row);
						}
						(state[day]||[]).forEach(addRow);
						addBtn.onclick=()=>addRow();
						head.append(addBtn);
						sec.append(head, list);
						el.daysWrap.append(sec);
					});
				}

				// Build a standalone editor instance (for per-workplace UI)
				function buildEditor(initialStr=''){
					const wrapper=document.createElement('div');
					wrapper.style.border='1px solid #e5e7eb'; wrapper.style.borderRadius='8px'; wrapper.style.padding='.5rem'; wrapper.style.marginTop='.5rem';
					const daysWrap=document.createElement('div'); wrapper.appendChild(daysWrap);
					function render(state){
						daysWrap.innerHTML='';
						DAYS.forEach(day=>{
							const sec=document.createElement('div'); sec.style.borderTop='1px solid #e5e7eb'; sec.style.padding='.5rem 0';
							const head=document.createElement('div'); head.style.display='flex'; head.style.justifyContent='space-between'; head.style.alignItems='center';
							head.innerHTML = `<strong>${day}</strong>`;
							const addBtn=document.createElement('button'); addBtn.className='btn'; addBtn.textContent='Add time'; addBtn.style.padding='.25rem .5rem'; addBtn.style.fontSize='.85rem';
							const list=document.createElement('div'); list.style.marginTop='.35rem';
							function addRow(range){
								const row=document.createElement('div'); row.className='mw-row'; row.style.display='flex'; row.style.gap='.5rem'; row.style.alignItems='center';
								const ti=makeTimeInputs(range?range.start:540, range?range.end:1020);
								const del=document.createElement('button'); del.className='btn btn-danger'; del.textContent='Remove'; del.style.padding='.25rem .5rem'; del.style.fontSize='.8rem';
								del.onclick=()=>{ row.remove(); };
								row.append(ti.element, del); list.append(row);
							}
							(state[day]||[]).forEach(addRow);
							addBtn.onclick=()=>addRow();
							head.append(addBtn);
							sec.append(head, list);
							daysWrap.append(sec);
						});
					}
					function parse(text){
						const map = { Sun: 'Sunday', Mon: 'Monday', Tue: 'Tuesday', Wed: 'Wednesday', Thu: 'Thursday', Fri: 'Friday', Sat: 'Saturday' };
						const availability = {}; if (!text) return availability;
						text.split(',').map(s => s.trim()).forEach(block => {
							let m = block.match(/^(Sun|Mon|Tue|Wed|Thu|Fri|Sat)\s+(\d{1,2})(?::(\d{2}))?\s*(am|pm)?\s*-\s*(\d{1,2})(?::(\d{2}))?\s*(am|pm)?$/i);
							if (!m) return; const day = map[m[1]];
							function toMin(h, mins, ap) { let hh=parseInt(h,10)||0; let mm=mins?parseInt(mins,10):0; if (ap) { const a=ap.toLowerCase(); if (a==='pm'&&hh<12) hh+=12; if (a==='am'&&hh===12) hh=0; } return hh*60+mm; }
							const start = toMin(m[2], m[3], m[4]); const end = toMin(m[5], m[6], m[7]);
							if (!availability[day]) availability[day] = []; availability[day].push({ start, end });
						});
						return availability;
					}
					function canonical(){
						const blocks=[]; const sections = daysWrap.querySelectorAll(':scope > div');
						sections.forEach(sec=>{ const day = sec.querySelector('strong').textContent; const rows = sec.querySelectorAll('.mw-row');
							rows.forEach(r=>{ const inputs = r.querySelectorAll('input, select'); if (inputs.length===2){ const [s,e]=[inputs[0].value, inputs[1].value]; if(!s||!e) return; const [sh,sm]=s.split(':').map(Number); const [eh,em]=e.split(':').map(Number); blocks.push(`${ABBR[day]} ${fmtHM(minutes(sh,sm))}-${fmtHM(minutes(eh,em))}`); } else if (inputs.length===6){ const [sh,sm,sap,eh,em,eap]=Array.from(inputs); const sMin=to24h(sh.value, sm.value, sap.value); const eMin=to24h(eh.value, em.value, eap.value); blocks.push(`${ABBR[day]} ${fmtHM(sMin)}-${fmtHM(eMin)}`); } }); });
						return blocks.join(', ');
					}
					// init
					render(parse(initialStr));
					return { root: wrapper, setFromString:(s)=>render(parse(s)), canonical, rerender:()=>render(parse(canonical())) };
				}

				// Per-workplace editors (add only)
				const perWpEditors = new Map();

				function parseAvailabilityString(text) {
					const days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
					const map = { Sun: 'Sunday', Mon: 'Monday', Tue: 'Tuesday', Wed: 'Wednesday', Thu: 'Thursday', Fri: 'Friday', Sat: 'Saturday' };
					const availability = {};
					if (!text) return availability;
					text.split(',').map(s => s.trim()).forEach(block => {
						// Accept both 24h and am/pm
						let m = block.match(/^(Sun|Mon|Tue|Wed|Thu|Fri|Sat)\s+(\d{1,2})(?::(\d{2}))?\s*(am|pm)?\s*-\s*(\d{1,2})(?::(\d{2}))?\s*(am|pm)?$/i);
						if (!m) return;
						const day = map[m[1]];
						function toMin(h, mins, ap) { let hh=parseInt(h,10)||0; let mm=mins?parseInt(mins,10):0; if (ap) { const a=ap.toLowerCase(); if (a==='pm'&&hh<12) hh+=12; if (a==='am'&&hh===12) hh=0; } return hh*60+mm; }
						const start = toMin(m[2], m[3], m[4]);
						const end = toMin(m[5], m[6], m[7]);
						if (!availability[day]) availability[day] = [];
						availability[day].push({ start, end });
					});
					return availability;
				}

				function stateFromString(avStr){ return parseAvailabilityString(avStr||''); }
				function canonicalFromEditor(){
					// Walk DOM rows and build canonical 24h string
					const blocks=[];
					const sections = el.daysWrap.querySelectorAll(':scope > div');
					sections.forEach(sec=>{
						const day = sec.querySelector('strong').textContent;
						const rows = sec.querySelectorAll('.mw-row');
						rows.forEach(r=>{
							const inputs = r.querySelectorAll('input, select');
							if (inputs.length===2) {
								const [s,e] = [inputs[0].value, inputs[1].value];
								if (!s||!e) return; const [sh,sm]=s.split(':').map(Number); const [eh,em]=e.split(':').map(Number);
								blocks.push(`${ABBR[day]} ${fmtHM(minutes(sh,sm))}-${fmtHM(minutes(eh,em))}`);
							} else if (inputs.length===6) {
								// AM/PM selects: sh, :, sm, sap, eh, :, em, eap (we only get selects: sh sm sap eh em eap)
								const [sh,sm,sap,eh,em,eap] = Array.from(inputs);
								const sMin = to24h(sh.value, sm.value, sap.value);
								const eMin = to24h(eh.value, em.value, eap.value);
								blocks.push(`${ABBR[day]} ${fmtHM(sMin)}-${fmtHM(eMin)}`);
							}
						});
					});
					return blocks.join(', ');
				}

				// Reset fields
				el.first.value = worker['First Name']||'';
				el.last.value = worker['Last Name']||'';
				el.email.value = worker['Email']||'';
				el.phone.value = worker['Phone Number']||worker['Phone']||'';
				el.fnum.value = worker['F Number']||worker['FNumber']||'';
				// Prefill Work Study based on canonical boolean or legacy fields
				const _wsPrefill = (worker.workStudy===true) || String(worker['Work Study']||'').toLowerCase()==='yes' || String(worker['Worker Type']||'').toLowerCase()==='work study';
				el.ws.value = _wsPrefill ? 'Yes' : 'No';
				el.suspended.value = String(worker.suspended===true);
				el.pinned.value = String(worker.isPinned!=null?worker.isPinned:false);
				el.avail.value = worker['Days & Times Available']||worker['Availability']||'';

				// Initialize editor from existing availability
				const initState = stateFromString(el.avail.value);
				renderDaysEditor(initState);

				function setMode(newMode){ inputMode=newMode; const isFree = inputMode==='free'; el.avail.style.display = isFree?'block':'none'; el.availEditor.style.display = isFree?'none':'block'; el.modeFree.style.background = isFree?'#2563eb':'#e5e7eb'; el.modeFree.style.color = isFree?'#fff':'#111827'; el.modeEditor.style.background = !isFree?'#2563eb':'#e5e7eb'; el.modeEditor.style.color = !isFree?'#fff':'#111827'; }
				function setFmt(fmt){ timeFormat=fmt; el.fmt24.style.background = fmt==='24h'?'#2563eb':'#e5e7eb'; el.fmt24.style.color = fmt==='24h'?'#fff':'#111827'; el.fmtAmPm.style.background = fmt==='ampm'?'#2563eb':'#e5e7eb'; el.fmtAmPm.style.color = fmt==='ampm'?'#fff':'#111827'; // re-render rows to switch inputs
					renderDaysEditor(stateFromString(canonicalFromEditor()||el.avail.value));
					// Rerender all per-workplace editors to adopt time format change
					perWpEditors.forEach(({ed})=> ed.rerender()); }
				el.modeFree.onclick = ()=> setMode('free');
				el.modeEditor.onclick = ()=> setMode('editor');
				el.fmt24.onclick = ()=> setFmt('24h');
				el.fmtAmPm.onclick = ()=> setFmt('ampm');
				setMode('editor'); setFmt('24h');
				// Build wp checkboxes
				wpGroup.innerHTML = '';
				WP_IDS.forEach(id=>{
					const idAttr = `mw-wp-${id}`;
					const lab = document.createElement('label'); lab.style.display='flex'; lab.style.alignItems='center'; lab.style.gap='.35rem';
					const cb = document.createElement('input'); cb.type='checkbox'; cb.value=id; cb.id=idAttr; cb.checked = preselectWps.includes(id);
					// When adding, show/hide a per-workplace availability editor when toggled
					cb.addEventListener('change', ()=>{
						if (!isEditParam) {
							if (cb.checked) {
								if (!perWpEditors.has(id)) {
									const ed = buildEditor('');
									const card = document.createElement('div'); card.style.marginTop='.5rem'; card.style.background='#f9fafb'; card.style.border='1px solid #e5e7eb'; card.style.borderRadius='10px'; card.style.padding='.5rem';
									const header = document.createElement('div'); header.style.display='flex'; header.style.justifyContent='space-between'; header.style.alignItems='center';
									header.innerHTML = `<strong>Availability ‚Äî ${labelForWp(id)}</strong>`;
									card.append(header, ed.root);
									el.perWpEditorsWrap.append(card);
									perWpEditors.set(id, { ed, card });
								}
							} else {
								const item = perWpEditors.get(id); if (item) { item.card.remove(); perWpEditors.delete(id); }
							}
						}
					});
					lab.append(cb, document.createTextNode(labelForWp(id))); wpGroup.append(lab);
				});
				// If editing, hide wp selection (editing in-place)
				wpRow.style.display = isEditParam ? 'none' : '';
				// In add mode, default-create editors for preselected WPs
				if (!isEditParam) {
					preselectWps.forEach(id=>{
						const cb=document.getElementById(`mw-wp-${id}`); if (cb && !cb.checked) { cb.checked = true; }
						cb && cb.dispatchEvent(new Event('change'));
					});
					// Hide the single shared editor in add mode; use per-WP editors
					el.avail.style.display='none'; el.availEditor.style.display='none';
				}
				// Multi-edit across workplaces: render per-WP editors even in edit mode
				if (isEditParam && forcePerWpEditors) {
					el.avail.style.display='none'; el.availEditor.style.display='none';
					preselectWps.forEach(id=>{
						if (!perWpEditors.has(id)) {
							const ed = buildEditor('');
							if (perWpPrefill && perWpPrefill[id]) ed.setFromString(perWpPrefill[id]);
							const card = document.createElement('div'); card.style.marginTop='.5rem'; card.style.background='#f9fafb'; card.style.border='1px solid #e5e7eb'; card.style.borderRadius='10px'; card.style.padding='.5rem';
							const header = document.createElement('div'); header.style.display='flex'; header.style.justifyContent='space-between'; header.style.alignItems='center';
							header.innerHTML = `<strong>Availability ‚Äî ${labelForWp(id)}</strong>`;
							card.append(header, ed.root);
							el.perWpEditorsWrap.append(card);
							perWpEditors.set(id, { ed, card });
						}
					});
				}
				title.textContent = isEditParam ? 'Edit Worker' : 'Add Worker';
				// Wire buttons
				const close = () => {
					// Hide and hard-reset any dynamic modal content so nothing leaks across sessions
					overlay.style.display='none';
					try {
						// Clear per-workplace editors and main day editor
						if (el.perWpEditorsWrap) el.perWpEditorsWrap.innerHTML = '';
						if (el.daysWrap) el.daysWrap.innerHTML = '';
						if (el.avail) el.avail.value = '';
						// Reset checkboxes (workplaces)
						if (wpGroup) wpGroup.querySelectorAll('input[type="checkbox"]').forEach(cb=> cb.checked = false);
					} catch {}
					resolve(null);
				};
				document.getElementById('mwCloseBtn').onclick = close;
				document.getElementById('mwCancel').onclick = close;
					document.getElementById('mwSave').onclick = () => {
					// Validate
					const first = el.first.value.trim(); const last = el.last.value.trim(); const email = el.email.value.trim();
					if (!first || !last || !email) { alert('First, Last, and Email are required'); return; }
						// Build availability string (canonical 24h, day abbreviations)
					let availability = '';
						if (inputMode==='free') {
						availability = el.avail.value.trim();
					} else {
						availability = canonicalFromEditor();
					}
					const data = {
						'First Name': first,
						'Last Name': last,
						'Email': email,
						'Phone Number': el.phone.value.trim(),
						'Phone': el.phone.value.trim(),
						'F Number': el.fnum.value.trim(),
						'Work Study': el.ws.value,
						workStudy: (el.ws.value === 'Yes'),
							'Availability': availability,
						isPinned: (el.pinned.value === 'true'),
						suspended: (el.suspended.value === 'true')
					};
						const selectedWps = Array.from(wpGroup.querySelectorAll('input[type="checkbox"]:checked')).map(c=>c.value);
						// Per-workplace availability mapping (add mode)
						const perWpAvail = {};
						if (!isEditParam || forcePerWpEditors) {
							for (const id of selectedWps) {
								const item = perWpEditors.get(id);
								perWpAvail[id] = item ? item.ed.canonical() : availability;
							}
							// Cross-workplace overlap validation (same person cannot be in two places at once)
							function parseAV(str){ return stateFromString(str); }
							const perDay = {};
							for (const id of selectedWps) {
								const av = parseAV(perWpAvail[id]);
								for (const [day, ranges] of Object.entries(av)) {
									if (!perDay[day]) perDay[day] = [];
									perDay[day].push(...ranges.map(r=>({ ...r, wp:id })));
								}
							}
							function hasOverlap(list){
								list.sort((a,b)=>a.start-b.start);
								for (let i=1;i<list.length;i++){ if (list[i].start < list[i-1].end) return true; }
								return false;
							}
							for (const day in perDay){ if (hasOverlap(perDay[day])) { alert(`Overlapping availability across workplaces on ${day}. A person can't be in two places at once. Please adjust.`); return; } }
						}
					overlay.style.display='none';
						resolve({ data, workplaces: selectedWps, perWpAvail, cleanup: isEditParam });
				};
				overlay.style.display='flex';
				// Ensure modal opens scrolled to top and focus first field
				setTimeout(()=>{
					const modal = overlay.querySelector('.modal');
					const body = overlay.querySelector('.modal .body');
					if (modal) modal.scrollTop = 0; if (body) body.scrollTop = 0; try { el.first.focus(); } catch {}
				}, 0);
			});
		}

		let renderVersion = 0; // bump each render to avoid stale double-append

		async function render() {
			const my = ++renderVersion;
			status.textContent = 'Loading‚Ä¶'; content.innerHTML = '';
			try {
				if (currentTab === 'users') {
					const usersRaw = await fetchUsers();
					if (my !== renderVersion) return; // stale render guard
					const q = uiState.searchTextByTab[currentTab] || '';
					const v = uiState.nameViewByTab[currentTab] || defaultNameView;
					const users = filterAndSortUsers(usersRaw, q, v);
					const frag = document.createDocumentFragment();
					frag.appendChild(buildSearchAndSortToolbar({ tabKey: currentTab }));
					frag.appendChild(renderUsersTable(users));
					if (my !== renderVersion) return; // final guard before DOM commit
					content.replaceChildren(frag);
					status.textContent = `Users: ${users.length}`; return;
				}
				if (currentTab === 'all') {
					const [workers, users] = [await fetchAllWorkers(), await fetchUsers()];
					if (my !== renderVersion) return;
					let joined = joinWorkersUsers(workers, users);
					// Aggregate by email so each person shows once across workplaces
					joined = aggregateByEmail(joined);
					const q = uiState.searchTextByTab[currentTab] || '';
					const v = uiState.nameViewByTab[currentTab] || defaultNameView;
					joined = filterAndSortWorkers(joined, q, v);
					const addHandler = async ()=>{
						const result = await openWorkerModal({ mode:'add', preselectWps: WP_IDS });
						if (!result) return;
						const { data, workplaces, perWpAvail } = result;
						if (!workplaces || workplaces.length===0) { alert('Choose at least one workplace'); return; }
						const nowMeta = { created_at: new Date().toISOString(), created_by: currentUser?.email||'system' };
						// Prevent duplicates within the same workplace (by Email)
						for (const wp of workplaces) {
							const dbSel = getDBForWorkplace(wp);
							const snap = await getDocs(query(collection(dbSel,'workers'), where('Email','==', data['Email'])));
							if (!snap.empty) { alert(`Worker with email ${data['Email']} already exists in ${labelForWp(wp)}. Skipping.`); continue; }
							const payload = { ...data, 'Availability': (perWpAvail&&perWpAvail[wp]) || data['Availability'], ...nowMeta };
							await addWorker(dbSel, payload);
						}
						await render();
					};
					const fragAll = document.createDocumentFragment();
					fragAll.appendChild(buildSearchAndSortToolbar({ onAdd: addHandler, tabKey: currentTab }));
					fragAll.appendChild(renderWorkersTable(joined, { allowCrud:false, showAllEdit:true }));
					if (my !== renderVersion) return; // final guard before DOM commit
					content.replaceChildren(fragAll);
					status.textContent = `All workers: ${joined.length}`; return;
				}
				// Workplace-specific tabs
				if (WP_IDS.includes(currentTab)) {
					const [rows, users] = [await fetchWorkersFor(currentTab), await fetchUsers()];
					if (my !== renderVersion) return;
					let joined = joinWorkersUsers(rows, users);
					const q = uiState.searchTextByTab[currentTab] || '';
					const v = uiState.nameViewByTab[currentTab] || defaultNameView;
					joined = filterAndSortWorkers(joined, q, v);
					const addHandler = async ()=>{
						const result = await openWorkerModal({ mode:'add', preselectWps:[currentTab] });
						if (!result) return; const { data, workplaces, perWpAvail } = result;
						const targets = (workplaces && workplaces.length>0) ? workplaces : [currentTab];
						const nowMeta = { created_at: new Date().toISOString(), created_by: currentUser?.email||'system' };
						for (const wp of targets) {
							const dbSel = getDBForWorkplace(wp);
							const snap = await getDocs(query(collection(dbSel,'workers'), where('Email','==', data['Email'])));
							if (!snap.empty) { alert(`Worker with email ${data['Email']} already exists in ${labelForWp(wp)}. Skipping.`); continue; }
							const payload = { ...data, 'Availability': (perWpAvail&&perWpAvail[wp]) || data['Availability'], ...nowMeta };
							await addWorker(dbSel, payload);
						}
						await render();
					};
					const fragWp = document.createDocumentFragment();
					fragWp.appendChild(buildSearchAndSortToolbar({ onAdd: addHandler, tabKey: currentTab }));
					fragWp.appendChild(renderWorkersTable(joined));
					if (my !== renderVersion) return; // final guard before DOM commit
					content.replaceChildren(fragWp);
					status.textContent = `${currentTab} workers: ${joined.length}`; return;
				}
			} catch (e) {
				status.textContent = e.message; status.classList.add('status-bad');
			}
		}

		// Start after admin check to avoid top-level return
		(async () => { if (await guardAdminOrRedirect()) { await render(); } })();
	</script>
</body>
</html>